# 1. Node 简介

# 1.1 历程

Ryan Dahl 在 2009 年发布了 Node.js 的第一个版本。2012 年转交给 Isaac Z. Schlueter (NPM 作者)。

## 1.2 命令和起源

Ryan Dahl 最初的目的是写一个基于事件驱动、非阻塞 I/O 的 Web 服务器，已达到更高的性能。JS 门槛低，没有历史包袱，并且 Chrome V8 引擎性能优异，所以选择了 JS。

Node 为构建大型分布式应用提供基础设施。

## 1.3 意义

Node 的结构与 Chrome 相似，都是基于事件驱动的异步架构，浏览器通过事件驱动来服务界面上的交互，Node 通过事件驱动来服务 I/O。

Node 打破了过去 JS 只能在浏览器中运行的局面，前后端编程环境统一，可以大大降低前后端转换所需要的上下文代价。

## 1.4 Node 的特点

### 1.4.1 异步 I/O

以读取文件为例，Node 不会阻塞进程等待文件读取完成。

```js
var fs = require('fs');
fs.readFile('/path', function (err, file) {
    console.log('读取文件完成');
});
console.log('发起读取文件');
```

以上示例中，"发起读取文件" 是在 "读取文件完成" 之前输出。

### 1.4.2 事件与回调函数

这是一个 Node 创建 Web 服务器的基本示例：

```js
var http = require('http');

// 侦听 request 事件
http.createServer(function (req, res) {
    var postData = '';
    req.setEncoding('utf8');
    // 侦听 data 事件
    req.on('data', function (chunk) {
        postData += chunk;
    });
    // 侦听 end 事件
    req.on('end', function () {
        res.end(postData);
    });
}).listen(3000);
```

事件的编程方式具有轻量级、松耦合、只关注事务点等优势。这个示例中回调无处不在，JS 中函数作为一等公民，作为对象传递给方法作为实参进行调用，这是一种最好的接受异步调用返回数据的方式。

### 1.4.3 单线程

Node 保持 JS 在浏览器中单线程特点。单线程的最最大好处是不用考虑多线程状态同步问题，这里没有死锁，也没有线程上下文切换的开销。

同样单线程也有缺点：

-   无法利用多核 CPU
-   错误会引起整个应用退出
-   大量计算占用 CPU 导致无法继续调用 I/O

浏览器中 JS 与 UI 共用一个线程，JS 长时间执行会导致 UI 的渲染和响应被中断。在 Node 中，长时间的 CPU 占用也会导致后续的异步 I/O 发不出调用，已完成的 I/O 回调得不到执行。

后来 H5 定制了 Web Worker，Node 推出了 child_process，允许启动子进程，用以利用多核 CPU。

### 1.4.4 跨平台

Node 基于 libuv 实现了跨平台，libuv 是 Node 的底层基础组件。

## 1.5 Node 的应用场景

### 1.5.1 I/O 密集型

Node 面向网络且擅长并行 I/O，能够有效地组织更多的硬件资源。I/O 密集主要在于 Node 事件循环的处理能力，并不是启动一个线程来请求服务，这样资源占用极少。

### 1.5.2 是否不擅长 CPU 密集型

由于单线程的原因，长时间的计算将导致 CPU 时间片不能释放。Node 虽然没有提供多线程用于计算支持，但有以下两个方式来充分利用 CPU：

-   通过编写 C/C++ 扩展的方式来更高效地利用 CPU
-   借助 child_process 来启动子进程，将计算任务交给其他进程来完成，利用进程消息传递结果

CPI 密集并不可怕，如何合理调用才是关键。

### 1.5.3 与遗留系统和平共处

旧系统可以持续为传统网站服务，同时提供数据源，Node 将数据源当作数据接口，发挥异步并行的优势。

### 1.5.4 分布式应用

Node 高效利用并行 I/O 的特性，适合构建分布式应用。

## 1.6 Node 的使用者

-   前后端编程语言环境统一：后端语言统一为 JS，前后端编程语言环境统一
-   构建实时应用：高性能 I/O
-   搭建分布式环境：并行 I/O
-   提升 Web 渲染能力：并行的 I/O 请求
-   云计算 Node 支持：Node 应用托管
-   游戏开发领域：实时和并发
-   工具类应用：Node 重写工具类应用
